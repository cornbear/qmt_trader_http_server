# 环境变量配置说明

**版本**: v1.2.0  
**功能**: 支持从 .env 文件读取配置

---

## 🎯 功能说明

QMT交易客户端现在支持从 `.env` 文件读取配置参数，避免在代码中硬编码敏感信息。

### 优势

- ✅ **安全性**: 敏感信息不会出现在代码中
- ✅ **灵活性**: 不同环境使用不同配置
- ✅ **便捷性**: 一次配置，处处使用
- ✅ **版本控制友好**: .env 文件不会被提交到Git

---

## 📦 安装依赖

```bash
# 安装 python-dotenv
pip install python-dotenv

# 或者从 requirements.txt 安装
pip install -r requirements.txt
```

---

## 🚀 快速开始

### 1. 创建 .env 文件

```bash
# Linux/Mac
cp env.example .env

# Windows
copy env.example .env
```

### 2. 编辑 .env 文件

```bash
# 编辑 .env 文件，填入您的实际配置
nano .env  # 或使用其他编辑器
```

示例内容：

```ini
# QMT服务器地址
QMT_BASE_URL=http://192.168.77.169:9091

# API认证信息
QMT_CLIENT_ID=outer
QMT_SECRET_KEY=cornbear

# 默认交易器索引
QMT_TRADER_INDEX=0

# 请求超时时间
QMT_TIMEOUT=30
```

### 3. 使用客户端

```python
from qmt_trade_client import QMTTradeClient

# ✨ 自动从 .env 文件读取所有配置
client = QMTTradeClient()

# 开始交易
portfolio = client.get_portfolio()
print(f"总资产: {portfolio['total_asset']}")
```

就这么简单！🎉

---

## 📋 支持的环境变量

| 环境变量 | 说明 | 默认值 | 必需 |
|---------|------|-------|------|
| `QMT_BASE_URL` | QMT服务器地址 | http://localhost:9091 | 否 |
| `QMT_CLIENT_ID` | API客户端ID | 无 | 签名认证时必需 |
| `QMT_SECRET_KEY` | API密钥 | 无 | 签名认证时必需 |
| `QMT_TRADER_INDEX` | 默认交易器索引 | 0 | 否 |
| `QMT_TIMEOUT` | 请求超时时间（秒） | 30 | 否 |

---

## 💡 使用方式

### 方式1: 完全使用 .env（推荐）

```python
from qmt_trade_client import QMTTradeClient

# 所有参数从 .env 文件读取
client = QMTTradeClient()
```

**优点**:
- 代码最简洁
- 配置集中管理
- 易于维护

### 方式2: .env + 手动覆盖

```python
from qmt_trade_client import QMTTradeClient

# 大部分参数从 .env 读取，只覆盖 trader_index
client = QMTTradeClient(trader_index=1)

# 或者覆盖多个参数
client = QMTTradeClient(
    base_url="http://other-server:9091",  # 覆盖 base_url
    trader_index=1  # 覆盖 trader_index
    # client_id 和 secret_key 从 .env 读取
)
```

**优点**:
- 灵活性高
- 可临时调整参数

### 方式3: 完全手动指定（兼容旧代码）

```python
from qmt_trade_client import QMTTradeClient

# 不使用 .env 文件
client = QMTTradeClient(
    base_url="http://localhost:9091",
    client_id="your_client_id",
    secret_key="your_secret_key",
    trader_index=0,
    env_file=None  # 禁用 .env 文件加载
)
```

**优点**:
- 完全控制
- 向后兼容

### 方式4: 指定自定义配置文件

```python
from qmt_trade_client import QMTTradeClient

# 使用自定义配置文件
client = QMTTradeClient(env_file=".env.production")

# 或在不同环境使用不同配置
import os
env_name = os.getenv("ENV", "development")
client = QMTTradeClient(env_file=f".env.{env_name}")
```

**优点**:
- 支持多环境
- 灵活配置

---

## 🔒 安全最佳实践

### 1. 不要提交 .env 文件

确保 `.gitignore` 包含 `.env`：

```gitignore
# .gitignore
.env
.env.*
!.env.example
!env.example
```

### 2. 使用 env.example 作为模板

提交 `env.example` 作为配置模板，但不包含真实密钥：

```bash
# 团队成员可以这样开始
cp env.example .env
# 然后填入自己的密钥
```

### 3. 定期轮换密钥

建议定期更换 API 密钥，增强安全性。

### 4. 限制文件权限

```bash
# Linux/Mac: 只有当前用户可读
chmod 600 .env
```

---

## 📂 文件结构示例

```
qmt_trader_http_server/
├── .env                    # 本地配置（不提交）
├── env.example             # 配置模板（提交）
├── qmt_trade_client.py     # 客户端代码
├── examples/
│   └── simple_trade.py     # 示例代码
└── .gitignore              # 忽略 .env 文件
```

---

## 🔄 参数优先级

配置参数的优先级（从高到低）：

1. **直接传入参数** - 最高优先级
2. **环境变量（.env 文件）** - 中等优先级
3. **默认值** - 最低优先级

示例：

```python
# .env 文件内容
QMT_BASE_URL=http://server1:9091
QMT_TRADER_INDEX=0

# Python 代码
client = QMTTradeClient(
    base_url="http://server2:9091",  # 覆盖 .env 中的设置
    trader_index=1  # 覆盖 .env 中的设置
)

# 实际使用的值：
# base_url = "http://server2:9091"  (来自参数)
# trader_index = 1  (来自参数)
```

---

## 🌍 多环境配置

### 开发环境

`.env.development`：
```ini
QMT_BASE_URL=http://localhost:9091
QMT_CLIENT_ID=dev_client
QMT_SECRET_KEY=dev_secret
QMT_TRADER_INDEX=0
```

### 测试环境

`.env.testing`：
```ini
QMT_BASE_URL=http://test-server:9091
QMT_CLIENT_ID=test_client
QMT_SECRET_KEY=test_secret
QMT_TRADER_INDEX=0
```

### 生产环境

`.env.production`：
```ini
QMT_BASE_URL=http://prod-server:9091
QMT_CLIENT_ID=prod_client
QMT_SECRET_KEY=prod_secret
QMT_TRADER_INDEX=0
```

### 使用方式

```python
import os
from qmt_trade_client import QMTTradeClient

# 根据环境变量选择配置文件
env = os.getenv("APP_ENV", "development")
client = QMTTradeClient(env_file=f".env.{env}")
```

或者使用环境变量：

```bash
# Linux/Mac
export APP_ENV=production
python your_script.py

# Windows
set APP_ENV=production
python your_script.py
```

---

## ❓ 常见问题

### Q1: .env 文件不生效？

**解决方法**:
1. 确认 .env 文件在当前工作目录
2. 检查文件内容格式是否正确
3. 确认已安装 python-dotenv

```bash
# 检查是否安装
pip show python-dotenv

# 如未安装
pip install python-dotenv
```

### Q2: 如何查看当前使用的配置？

```python
client = QMTTradeClient()

print(f"Base URL: {client.base_url}")
print(f"Client ID: {client.client_id}")
print(f"Trader Index: {client.trader_index}")
print(f"Timeout: {client.timeout}")
```

### Q3: 如何在不同目录使用配置文件？

```python
from pathlib import Path

# 方式1: 指定绝对路径
config_path = Path("/path/to/your/.env")
client = QMTTradeClient(env_file=str(config_path))

# 方式2: 相对于脚本目录
script_dir = Path(__file__).parent
config_path = script_dir / ".env"
client = QMTTradeClient(env_file=str(config_path))
```

### Q4: 如何完全禁用 .env 文件？

```python
# 设置 env_file=None
client = QMTTradeClient(
    base_url="http://localhost:9091",
    client_id="xxx",
    secret_key="xxx",
    env_file=None  # 不加载任何 .env 文件
)
```

### Q5: 未安装 python-dotenv 会怎样？

如果未安装 `python-dotenv`，客户端会：
1. 显示警告信息
2. 继续运行（不会报错）
3. 只能使用手动传入的参数或默认值

---

## 📚 相关文档

- [QMT_CLIENT_使用手册.md](QMT_CLIENT_使用手册.md) - 完整使用指南
- [QMT客户端优化说明.md](QMT客户端优化说明.md) - 优化说明
- [env.example](env.example) - 配置文件模板

---

## 🎉 总结

使用 .env 配置的优势：

| 特性 | 传统方式 | .env 方式 |
|-----|---------|----------|
| 安全性 | ⚠️ 代码中有密钥 | ✅ 密钥独立管理 |
| 灵活性 | ❌ 修改需改代码 | ✅ 修改配置文件即可 |
| 多环境 | ❌ 需要多份代码 | ✅ 多份配置文件 |
| 版本控制 | ⚠️ 可能泄露密钥 | ✅ 密钥不提交 |
| 易用性 | ⚠️ 参数繁琐 | ✅ 一次配置 |

**推荐使用 .env 配置方式！** 🚀

---

**文档版本**: v1.0  
**最后更新**: 2024年10月16日  
**作者**: QMT交易系统开发团队

