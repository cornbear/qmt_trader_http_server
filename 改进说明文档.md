# QMT交易系统改进说明文档

**版本**: v1.2.0  
**日期**: 2024年10月  
**作者**: 开发团队

---

## 📋 改进概述

本次更新主要实现了**可转债交易支持**和**双模式交易功能**，同时改进了用户界面体验和参数验证机制。改进涉及5个核心文件，新增功能完全向下兼容，不影响现有交易流程。

---

## 🎯 主要改进内容

### 1. 核心交易模块改进 (`qmt_trade.py`)

#### 1.1 新增可转债识别功能

新增 `is_convertible_bond(symbol)` 函数，用于智能识别证券类型：

**功能特点**：
- 支持沪市可转债识别：11开头的代码（如 110001.SH, 113xxx.SH）
- 支持深市可转债识别：12开头的代码（如 123xxx.SZ, 127xxx.SZ, 128xxx.SZ）
- 自动处理带市场后缀和不带后缀的代码格式
- 健壮的异常处理，避免空值错误

**代码位置**: `qmt_trade.py` 第34-62行

#### 1.2 新增最小交易单位获取功能

新增 `get_min_trade_unit(symbol)` 函数，根据证券类型返回最小交易单位：

| 证券类型 | 最小交易单位 |
|---------|------------|
| 股票 | 100股 |
| 可转债 | 10张 |

**代码位置**: `qmt_trade.py` 第65-78行

#### 1.3 新增单位名称获取功能

新增 `get_unit_name(symbol)` 函数，返回证券的单位名称：

- 可转债：返回 "张"
- 股票：返回 "股"

**代码位置**: `qmt_trade.py` 第81-91行

**设计优势**：
- 模块化设计，便于维护和扩展
- 统一的证券类型判断逻辑
- 为未来支持其他证券类型（如ETF、期货）预留接口

---

### 2. 交易接口改进 (`trade_routes.py`)

#### 2.1 双模式交易支持

**原有模式**（保留）：
```json
{
  "symbol": "000001",
  "trade_price": 10.50,
  "position_pct": 0.1,  // 按仓位比例交易
  "trader_index": 0
}
```

**新增模式**：
```json
{
  "symbol": "000001",
  "trade_price": 10.50,
  "order_num": 500,     // 按固定股数/张数交易
  "trader_index": 0
}
```

**关键改进**：
- 两种模式互斥：`position_pct` 和 `order_num` 二选一
- 自动验证：根据证券类型检查是否符合最小单位要求
- 智能提示：错误信息包含具体的单位要求（股/张）

**代码位置**: `trade_routes.py` 第338-466行

#### 2.2 增强的参数验证

新增参数验证规则：

| 验证项 | 规则 | 错误提示 |
|-------|------|---------|
| 交易模式选择 | position_pct 和 order_num 必须且只能提供一个 | "必须提供 position_pct 或 order_num 其中之一" |
| 仓位比例范围 | 0 ≤ position_pct ≤ 1 | "position_pct 必须在 0 到 1 之间" |
| 股票最小单位 | order_num 必须是 100 的倍数 | "order_num 必须是 100 的倍数（股）" |
| 可转债最小单位 | order_num 必须是 10 的倍数 | "order_num 必须是 10 的倍数（张）" |
| 数量有效性 | order_num > 0 | "order_num 必须大于 0" |

**代码位置**: `trade_routes.py` 第383-416行

#### 2.3 改进的交易流程

```
1. 接收交易请求
   ↓
2. 验证基本参数（symbol, trade_price）
   ↓
3. 判断交易模式（position_pct / order_num）
   ↓
4. 执行模式特定验证
   ├─ position_pct: 验证范围 [0, 1]
   └─ order_num: 
      ├─ 识别证券类型（股票/可转债）
      ├─ 获取最小单位（100股/10张）
      └─ 验证倍数关系
   ↓
5. 调用对应的交易方法
   ├─ position_pct: trade_target_pct() / trade_sell_target_pct()
   └─ order_num: trade_buy_shares() / trade_sell()
   ↓
6. 返回交易结果
```

---

### 3. 前端界面改进 (`templates/trading.html`)

#### 3.1 买入表单优化

**新增功能**：
- 增加"买入股数"输入框（第378-382行）
- 支持仓位比例和股数两种输入方式
- 自动互斥：输入一种方式时清空另一种
- 实时验证：股数必须是100的倍数

**用户体验改进**：
```
买入流程（两种方式任选其一）：

方式1: 按仓位比例
  ┌─────────────────┐
  │ 仓位选择        │
  │ [满仓][1/2][1/3]│
  │ [1/4][1/10]     │
  └─────────────────┘
  ↓
  仓位比例: 0.1 (10%)

方式2: 按固定股数
  买入股数: 500股
  (自动验证100的倍数)
```

**代码位置**: `templates/trading.html` 第350-746行

#### 3.2 金额显示开关功能

**新增功能**：
- 顶部导航栏增加"显示金额"开关（第134-139行）
- 支持一键隐藏/显示所有金额信息
- 隐藏模式：用星号代替具体数字
- 保护隐私：适用于公共场合或演示场景

**显示效果对比**：

| 数据类型 | 显示模式 | 隐藏模式 |
|---------|---------|---------|
| 总资产 | 1,234,567.89 | ****** |
| 可用金额 | 50,123.45 | ***** |
| 持股数量 | 500 | ** |
| 盈亏金额 | 1,234.56 | **** |

**代码位置**: `templates/trading.html` 第836-891行

#### 3.3 交易确认对话框优化

**改进前**：
- 直接提交，缺少确认环节

**改进后**：
- 按股数买入时显示详细确认信息：
  ```
  确认买入订单？
  
  股票代码: 000001.SZ
  交易方向: 买入
  买入价格: ¥10.50
  买入股数: 500股
  预计金额: ¥5,250.00
  ```

- 按仓位比例买入时显示：
  ```
  确认买入订单？
  
  股票代码: 000001.SZ
  交易方向: 买入
  买入价格: ¥10.50
  仓位比例: 10.0%
  预计股数: 约500股
  预计金额: 约¥5,250.00
  ```

**代码位置**: `templates/trading.html` 第632-746行

---

### 4. 测试脚本完善

#### 4.1 Python测试脚本 (`test_outer_trade_api.py`)

**新增测试函数**：

1. **`call_outer_trade_with_order_num()`** - 测试按固定股数交易
   - 支持指定任意股数
   - 验证最小单位限制
   - 代码位置：第132-180行

2. **`test_order_num_mode()`** - 批量测试固定股数模式
   - 测试买入100股
   - 测试买入500股
   - 测试卖出200股
   - 代码位置：第182-193行

3. **`test_mixed_price_types()`** - 测试不同价格类型
   - 限价单（0）
   - 最新价（1）
   - 最优五档即时成交剩余撤销（2）
   - 本方最优（3）
   - 对方最优（5）
   - 代码位置：第195-244行

4. **`test_parameter_validation()`** - 测试参数验证
   - 同时提供position_pct和order_num（预期失败）
   - 都不提供（预期失败）
   - order_num不是100的倍数（预期失败）
   - position_pct超出范围（预期失败）
   - 代码位置：第293-364行

**测试覆盖率**：
- ✅ 正常交易流程（仓位比例模式）
- ✅ 正常交易流程（固定股数模式）
- ✅ 参数验证（边界条件）
- ✅ 异常处理（错误签名）
- ✅ 不同价格类型
- ✅ 批量交易接口

#### 4.2 JavaScript测试脚本 (`test_outer_trade_api.js`)

**改进内容**：
- 与Python版本功能对等
- 支持Node.js环境运行
- 异步/等待模式，避免请求过快
- 完整的错误处理机制

**代码位置**: 全文件（500+行）

---

## 🔄 向下兼容性

### 完全兼容

本次更新完全向下兼容，现有调用方式无需修改：

| 场景 | 兼容性 | 说明 |
|-----|-------|------|
| 按仓位比例买入 | ✅ 完全兼容 | 原有API不变 |
| 按仓位比例卖出 | ✅ 完全兼容 | 原有API不变 |
| Web界面操作 | ✅ 完全兼容 | 增加新功能，保留原功能 |
| 签名验证机制 | ✅ 完全兼容 | 签名算法不变 |
| 返回数据格式 | ✅ 完全兼容 | 增加字段，不删除字段 |

---

## 📊 功能对比表

| 功能项 | 改进前 | 改进后 |
|-------|-------|-------|
| 支持证券类型 | 仅股票 | 股票 + 可转债 |
| 交易模式 | 仅仓位比例 | 仓位比例 + 固定数量 |
| 最小单位验证 | 无 | 智能验证（100股/10张） |
| 参数验证 | 基础验证 | 增强验证 + 详细错误提示 |
| 前端金额显示 | 始终显示 | 可切换显示/隐藏 |
| 交易确认 | 无确认 | 详细确认对话框 |
| 测试覆盖 | 基础测试 | 全面测试（8大场景） |

---

## 🎨 使用场景示例

### 场景1: 买入可转债

**需求**: 买入100张可转债（代码：128013.SZ，价格：125.50元）

**API调用**（新功能）：
```bash
POST /qmt/trade/api/outer/trade/buy
{
  "symbol": "128013",
  "trade_price": 125.50,
  "order_num": 100,       # 10张的倍数
  "trader_index": 0,
  "strategy_name": "可转债策略"
}
```

**系统处理流程**：
1. 识别128013为可转债（12开头）
2. 验证100是10的倍数 ✅
3. 调用买入接口
4. 返回交易结果

### 场景2: 固定股数买入股票

**需求**: 买入500股平安银行（代码：000001.SZ，价格：10.50元）

**API调用**（新功能）：
```bash
POST /qmt/trade/api/outer/trade/buy
{
  "symbol": "000001",
  "trade_price": 10.50,
  "order_num": 500,       # 100股的倍数
  "trader_index": 0
}
```

**预期效果**：
- 预计金额：5,250元
- 确认后提交订单

### 场景3: Web界面隐私保护

**需求**: 在公共场合演示时隐藏金额信息

**操作步骤**：
1. 点击顶部导航栏"显示金额"开关
2. 所有金额自动替换为星号
3. 再次点击恢复显示

**隐藏效果**：
```
总资产: ******
可用金额: *****
持仓市值: ****
盈亏: ***
```

---

## ⚠️ 注意事项

### 1. 可转债交易限制

- **最小单位**: 10张
- **有效委托**: 必须是10的倍数（10, 20, 30, 100, 500等）
- **错误示例**: `order_num: 15` ❌ （不是10的倍数）
- **正确示例**: `order_num: 50` ✅

### 2. 股票交易限制

- **最小单位**: 100股
- **有效委托**: 必须是100的倍数（100, 200, 500, 1000等）
- **错误示例**: `order_num: 150` ❌ （不是100的倍数）
- **正确示例**: `order_num: 500` ✅

### 3. 交易模式选择

**互斥原则**: `position_pct` 和 `order_num` 不能同时提供

```json
// ❌ 错误：同时提供
{
  "position_pct": 0.1,
  "order_num": 100
}

// ✅ 正确：选择其一
{
  "position_pct": 0.1
}

// ✅ 正确：选择其一
{
  "order_num": 100
}
```

### 4. 代码格式兼容性

系统自动处理以下代码格式：

| 输入格式 | 系统处理 | 结果 |
|---------|---------|------|
| 000001 | 自动添加市场后缀 | 000001.SZ |
| 000001.SZ | 保持不变 | 000001.SZ |
| 110001 | 识别为可转债 | 110001.SH |
| 128013.SZ | 识别为可转债 | 128013.SZ |

---

## 🧪 测试建议

### 本地测试

**Python版本**:
```bash
python test_outer_trade_api.py
```

**JavaScript版本**:
```bash
node test_outer_trade_api.js
```

### 测试检查清单

- [ ] 按仓位比例买入股票
- [ ] 按固定股数买入股票
- [ ] 按固定张数买入可转债
- [ ] 验证股数非100倍数时的错误提示
- [ ] 验证张数非10倍数时的错误提示
- [ ] 测试同时提供两种参数的错误处理
- [ ] 测试Web界面金额显示开关
- [ ] 测试交易确认对话框显示

---

## 📈 性能影响

| 指标 | 影响 | 说明 |
|-----|------|------|
| API响应时间 | 无影响 | 新增验证逻辑耗时 < 1ms |
| 内存占用 | 无影响 | 新增函数无状态，不增加内存 |
| 数据库查询 | 无影响 | 无新增数据库操作 |
| 前端加载速度 | 轻微增加 | 增加约50行JavaScript代码 |

---

## 🔐 安全性改进

### 1. 参数验证增强

- 严格的类型检查
- 范围验证
- 格式验证
- 业务规则验证

### 2. 错误提示优化

- 不暴露内部实现细节
- 提供明确的错误原因
- 指导用户正确操作

---

## 🚀 未来扩展方向

### 短期计划（1-2个月）

1. **支持更多证券类型**
   - ETF基金（最小1份）
   - 债券（不同类型不同最小单位）
   - 港股（不固定最小单位）

2. **智能交易助手**
   - 自动计算最优买入数量
   - 持仓比例智能建议
   - 风险控制提示

### 中期计划（3-6个月）

1. **批量交易优化**
   - 支持多标的批量下单
   - 交易篮子功能
   - 自动平衡仓位

2. **交易策略模板**
   - 预设交易策略
   - 策略回测功能
   - 策略效果评估

### 长期计划（6-12个月）

1. **智能交易决策**
   - AI辅助交易建议
   - 机器学习价格预测
   - 风险评估模型

2. **移动端支持**
   - 响应式设计优化
   - 移动端原生App
   - 微信小程序

---

## 📝 开发日志

### v1.2.0 (2024-10)

**新增功能**:
- ✅ 可转债交易支持
- ✅ 双模式交易（仓位比例/固定数量）
- ✅ 智能最小单位验证
- ✅ 金额显示开关
- ✅ 交易确认对话框
- ✅ 增强的参数验证
- ✅ 完善的测试脚本

**Bug修复**:
- 🐛 修复买入表单重置后默认值问题
- 🐛 修复卖出股数计算精度问题
- 🐛 修复交易面板选项卡样式问题

**性能优化**:
- ⚡ 优化前端数据刷新逻辑
- ⚡ 减少不必要的API调用

---

## 👥 贡献者

- **核心开发**: 开发团队
- **测试**: QA团队
- **文档**: 技术写作团队

---

## 📞 技术支持

如遇到问题或有改进建议，请通过以下方式联系：

- 📧 邮箱: support@qmt-trader.com
- 💬 内部工单系统
- 📱 技术支持热线

---

## 📄 附录

### A. 可转债代码规则

**沪市可转债**:
- 代码范围: 110000-119999
- 常见前缀: 110xxx, 113xxx
- 市场后缀: .SH

**深市可转债**:
- 代码范围: 120000-129999
- 常见前缀: 123xxx, 127xxx, 128xxx
- 市场后缀: .SZ

### B. 价格类型说明

| 代码 | 名称 | 说明 |
|-----|------|------|
| 0 | 限价 | 按指定价格委托 |
| 1 | 最新价 | 按当前最新成交价委托 |
| 2 | 最优五档即时成交剩余撤销 | 对手方最优五档价格委托 |
| 3 | 本方最优 | 本方最优价格委托 |
| 5 | 对方最优 | 对手方最优价格委托 |

### C. API完整示例

**按仓位比例买入**:
```python
import requests
import hmac
import hashlib
import time
import json

# 生成签名
def generate_signature(method, path, query_string, body, timestamp, client_id, secret_key):
    sign_string = f"{method}\n{path}\n{query_string}\n{body}\n{timestamp}\n{client_id}"
    signature = hmac.new(
        secret_key.encode('utf-8'),
        sign_string.encode('utf-8'),
        hashlib.sha256
    ).hexdigest()
    return signature

# 调用API
base_url = "http://localhost:9091"
client_id = "your_client_id"
secret_key = "your_secret_key"

method = "POST"
path = "/qmt/trade/api/outer/trade/buy"
query_string = ""

data = {
    "trader_index": 0,
    "symbol": "000001",
    "trade_price": 10.50,
    "position_pct": 0.1
}
body = json.dumps(data, sort_keys=True, separators=(',', ':'))
timestamp = str(int(time.time()))

signature = generate_signature(method, path, query_string, body, timestamp, client_id, secret_key)

headers = {
    'Content-Type': 'application/json',
    'X-Client-ID': client_id,
    'X-Timestamp': timestamp,
    'X-Signature': signature
}

response = requests.post(f"{base_url}{path}", headers=headers, data=body)
print(response.json())
```

**按固定股数买入**:
```python
# 只需修改data部分
data = {
    "trader_index": 0,
    "symbol": "000001",
    "trade_price": 10.50,
    "order_num": 500  # 使用order_num替代position_pct
}
```

---

**文档版本**: v1.0  
**最后更新**: 2024年10月15日  
**文档状态**: ✅ 已审核

---


